<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haikyu!! Ultimate Optimizer</title>
    <style>
        :root { --hq-orange: #ff6b00; --hq-black: #1a1a1a; --hq-gray: #f4f4f9; --hq-blue: #0056b3; --hq-purple: #6f42c1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--hq-gray); color: var(--hq-black); padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Layout */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2, h3 { color: var(--hq-orange); margin-top: 0; }
        
        /* Inputs */
        label { display: block; font-weight: bold; margin-top: 8px; font-size: 0.8em; color:#444; }
        input, select { width: 100%; padding: 6px; margin-top: 2px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .hint { font-size: 0.8em; color: #666; font-style: italic; margin-top: 2px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        /* Substat specific grid */
        .sub-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; align-items: end; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .sub-grid label { margin-top:0; font-size: 0.75em; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; background: var(--hq-orange); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .btn:hover { background: #e65c00; }
        .btn-green { background: #28a745; } .btn-green:hover { background: #218838; }
        .btn-delete { background: #cc0000; padding: 2px 6px; font-size: 0.8em; color: white; border: none; cursor: pointer; float: right; }

        /* Team Styles */
        .team-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px; }
        .team-slot { background: #eee; border: 2px solid #ccc; border-radius: 6px; padding: 8px 2px; text-align: center; cursor: pointer; transition: 0.2s; }
        .team-slot:hover { border-color: var(--hq-orange); }
        .team-slot.active { border-color: var(--hq-orange); background: #fff5eb; box-shadow: 0 0 8px rgba(255, 107, 0, 0.4); }
        .slot-role { font-size: 0.65em; color: #666; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .slot-name { font-weight: bold; font-size: 0.75em; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Info Panels */
        .buff-panel { background: #eef6ff; padding: 15px; border-radius: 8px; border: 1px solid #0056b3; }
        .memory-panel { background: #f3e5f5; padding: 15px; border-radius: 8px; border: 1px solid var(--hq-purple); margin-bottom: 15px; }
        .ref-panel { background: #fff8e1; padding: 10px; border: 1px solid #ffc107; font-size: 0.8em; margin-bottom: 15px; border-radius: 6px;}
        
        /* Inventory & Results */
        .item-box { border-left: 4px solid var(--hq-orange); background: #fff5eb; padding: 8px; margin-bottom: 6px; font-size: 0.85em; }
        .result-box { background: #1a1a1a; color: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .creator-section { border-top: 2px dashed #ccc; margin-top: 20px; padding-top: 20px; }
    </style>
</head>
<body>

<h1>üèê Haikyu!! Ultimate Optimizer</h1>

<div class="card">
    <h2>1. Team Roster</h2>
    <div class="team-row">
        <div class="team-slot active" onclick="selectSlot(1)" id="slot1"><span class="slot-role">Slot 1</span><span class="slot-name" id="name1">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(2)" id="slot2"><span class="slot-role">Slot 2</span><span class="slot-name" id="name2">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(3)" id="slot3"><span class="slot-role">Slot 3</span><span class="slot-name" id="name3">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(4)" id="slot4"><span class="slot-role">Slot 4</span><span class="slot-name" id="name4">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(5)" id="slot5"><span class="slot-role">Slot 5</span><span class="slot-name" id="name5">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(6)" id="slot6"><span class="slot-role">Slot 6</span><span class="slot-name" id="name6">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(7)" id="slot7" style="border-color: #0056b3; background: #eef6ff;"><span class="slot-role" style="color:#0056b3;">LIBERO</span><span class="slot-name" id="name7">Empty</span></div>
    </div>
    <div style="background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <label>Assign Character:</label>
        <select id="charSelector" onchange="assignCharacter()"><option value="">-- Select --</option></select>
    </div>

    <div class="creator-section">
        <h3>‚ûï Add Custom Character</h3>
        <div class="stat-grid">
            <div style="grid-column: span 3;"><input type="text" id="new_name" placeholder="Name"></div>
            <div><input type="number" id="new_spike" placeholder="Spike"></div>
            <div><input type="number" id="new_block" placeholder="Block"></div>
            <div><input type="number" id="new_receive" placeholder="Rec"></div>
            <div><input type="number" id="new_serve" placeholder="Serve"></div>
            <div><input type="number" id="new_set" placeholder="Set"></div>
            <div><input type="number" id="new_save" placeholder="Save"></div>
            <div><input type="number" id="new_aware" placeholder="Aware"></div>
            <div><input type="number" id="new_reflex" placeholder="Reflex"></div>
            <div><input type="number" id="new_spirit" placeholder="Spirit"></div>
            <div><input type="number" id="new_str" placeholder="Str"></div>
            <div><input type="number" id="new_atech" placeholder="Atk Tech"></div>
            <div><input type="number" id="new_dtech" placeholder="Def Tech"></div>
        </div>
        <button class="btn btn-green" onclick="saveCustomCharacter()">Save Character</button>
    </div>
</div>

<div class="grid-container">
    <div>
        <div class="card">
            <h2>2. Stats & Conditions</h2>
            <p class="hint">Base Stats (Editable):</p>
            <div class="stat-grid" style="margin-bottom: 15px;">
                <div><label>Spike</label><input type="number" id="base_spike" value="0"></div>
                <div><label>Block</label><input type="number" id="base_block" value="0"></div>
                <div><label>Receive</label><input type="number" id="base_receive" value="0"></div>
                <div><label>Serve</label><input type="number" id="base_serve" value="0"></div>
                <div><label>Set</label><input type="number" id="base_set" value="0"></div>
                <div><label>Save</label><input type="number" id="base_save" value="0"></div>
                <div><label>Aware</label><input type="number" id="base_aware" value="0"></div>
                <div><label>Reflex</label><input type="number" id="base_reflex" value="0"></div>
                <div><label>Spirit</label><input type="number" id="base_spirit" value="0"></div>
                <div><label>Strength</label><input type="number" id="base_str" value="0"></div>
                <div><label>Atk Tech</label><input type="number" id="base_atech" value="0"></div>
                <div><label>Def Tech</label><input type="number" id="base_dtech" value="0"></div>
            </div>

            <div class="memory-panel">
                <h3 style="color:var(--hq-purple); margin:0;">üß† Equip Memory</h3>
                <select id="memorySelector" onchange="updateMemoryDesc()"><option value="">-- None --</option></select>
                <div id="memoryDesc" style="font-size:0.85em; margin-top:5px; font-style:italic;"></div>
            </div>

            <div class="buff-panel">
                <h3>‚öîÔ∏è Battle Conditions</h3>
                <p class="hint">Add % buffs from Skills/Passives (e.g. Mode Changes).</p>
                <div class="stat-grid">
                    <div><label>Spike %</label><input type="number" id="buff_spike" placeholder="0"></div>
                    <div><label>Block %</label><input type="number" id="buff_block" placeholder="0"></div>
                    <div><label>Rec %</label><input type="number" id="buff_receive" placeholder="0"></div>
                    <div><label>Serve %</label><input type="number" id="buff_serve" placeholder="0"></div>
                    <div><label>Aware %</label><input type="number" id="buff_aware" placeholder="0"></div>
                    <div><label>Reflex %</label><input type="number" id="buff_reflex" placeholder="0"></div>
                    <div><label>Team X</label><input type="number" id="buff_team" placeholder="1.0" value="1.0"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>4. Optimizer</h2>
            <label>Target Stat:</label>
            <select id="targetStat">
                <option value="spike">Spike Power</option>
                <option value="block">Block</option>
                <option value="receive">Receive</option>
                <option value="serve">Serve</option>
                <option value="set">Set</option>
                <option value="save">Save</option>
            </select>
            <button class="btn" onclick="runOptimizer()">Find Best Build</button>
            <div id="output" class="result-box" style="display:none;">
                <h3>üèÜ Best Build</h3>
                <div id="resultDetails"></div>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <h2>3. Potential Inventory</h2>
            
            <div class="ref-panel">
                <strong>Substat Ref:</strong> Flat +24 | % +2% | Spirit/Str +3.2% | Reflex/Awar +1.6% | Techs +1.2%
            </div>

            <div style="border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px;">
                <label>Set Name</label>
                <select id="pot_set">
                    <option value="Power Vibe">Power Vibe</option>
                    <option value="Assist Receive">Assist Receive</option>
                    <option value="Supreme Receive">Supreme Receive</option>
                    <option value="Precise Set">Precise Set</option>
                    <option value="Rapid Attack">Rapid Attack</option>
                    <option value="Sharp Sense">Sharp Sense</option>
                    <option value="Precise Block">Precise Block</option>
                    <option value="Block Movement">Block Movement</option>
                    <option value="Other">Other</option>
                </select>

                <div class="stat-grid" style="grid-template-columns: 1fr 1fr;">
                    <div><label>Slot</label><select id="pot_slot" onchange="updateSlotHint()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                    <div><label>Main Type</label><select id="pot_main_type"><option value="spike">Spike</option><option value="block">Block</option><option value="receive">Rec</option><option value="serve">Srv</option><option value="set">Set</option><option value="aware">Aware</option><option value="reflex">Reflex</option><option value="spirit">Spirit</option><option value="str">Str</option><option value="atech">Atk Tech</option><option value="dtech">Def Tech</option><option value="save">Save</option></select></div>
                </div>

                <div class="stat-grid" style="grid-template-columns: 1fr 1fr;">
                    <div><label>Main Val</label><input type="number" id="pot_main_val" placeholder="300"></div>
                    <div style="margin-top:35px;"><label><input type="checkbox" id="pot_main_is_percent"> Is %?</label></div>
                </div>
                <div id="slotHint" class="hint" style="color:#d32f2f; margin-bottom:10px;"></div>

                <label>Substats (Split Flat and %)</label>
                <div class="sub-grid">
                    <div><strong>Stat</strong></div><div><strong>Flat</strong></div><div><strong>%</strong></div>
                    
                    <label>Spike</label> <input type="number" id="sub_spike_flat" placeholder="24"> <input type="number" id="sub_spike_pct" placeholder="2">
                    <label>Block</label> <input type="number" id="sub_block_flat" placeholder="0"> <input type="number" id="sub_block_pct" placeholder="0">
                    <label>Receive</label> <input type="number" id="sub_receive_flat" placeholder="0"> <input type="number" id="sub_receive_pct" placeholder="0">
                    <label>Serve</label> <input type="number" id="sub_serve_flat" placeholder="0"> <input type="number" id="sub_serve_pct" placeholder="0">
                    <label>Set</label> <input type="number" id="sub_set_flat" placeholder="0"> <input type="number" id="sub_set_pct" placeholder="0">
                    <label>Aware</label> <input type="number" id="sub_aware_flat" placeholder="0"> <input type="number" id="sub_aware_pct" placeholder="0">
                    <label>Reflex</label> <input type="number" id="sub_reflex_flat" placeholder="0"> <input type="number" id="sub_reflex_pct" placeholder="0">
                    </div>
                
                <button class="btn btn-secondary" onclick="addPotential()">+ Add Potential</button>
            </div>

            <h3>Inventory (<span id="count">0</span>)</h3>
            <div id="inventoryList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<script>
    // --- DATA ---
    let characterDB = {
        "tsukishima_sp": { 
            name: "Tsukishima SP (MB)", 
            stats: { spike: 1948, receive: 1661, serve: 1668, block: 1769, set: 1579, save: 1753, aware: 0, reflex:0, spirit:0, str: 0, atech:0, dtech:0 } 
        }
    };

    let memoryDB = {
        "mem_tsuki_sp": { name: "Tsukishima SP Memory", desc: "Quick Atk +24%. Good Play = Block +9% (Stack x3).", buffs: { spike: 24 } },
        "mem_generic": { name: "Generic Memory", desc: "No base buffs.", buffs: {} }
    };

    const setBonuses = {
        "Power Vibe": { 2: {stat: "spike", val: 0.15} }, 
        "Assist Receive": { 2: {stat: "receive", val: 0.15} }, 
        "Supreme Receive": { 2: {stat: "receive", val: 0.15} },
        "Precise Set": { 2: {stat: "set", val: 0.15} },
        "Rapid Attack": { 2: {stat: "spike", val: 0.15} },
        "Sharp Sense": { 2: {stat: "spike", val: 0.15} },
        "Precise Block": { 2: {stat: "block", val: 0.15} },
        "Block Movement": { 2: {stat: "block", val: 0.15} }
    };

    // --- STATE ---
    let activeSlot = 1;
    let teamRoster = Array(7).fill(null); 
    let inventory = [];
    let idCounter = 0;

    // --- INIT ---
    window.onload = function() {
        loadCustomChars();
        updateCharDropdown();
        updateMemoryDropdown();
        loadInventory();
        updateSlotHint();
    };

    // --- LOGIC ---
    function updateSlotHint() {
        const s = document.getElementById('pot_slot').value;
        const h = document.getElementById('slotHint');
        const c = document.getElementById('pot_main_is_percent');
        
        if(s === "2") {
            h.innerText = "Max: 35% (Set/Atk/Srv) OR 20% (Aware/Str)";
            c.checked = true;
        } else if(s === "4") {
            h.innerText = "Max: 35% (Blk/Rec) OR 20% (Reflex/Spirit)";
            c.checked = true;
        } else if(s === "6") {
            h.innerText = "Max: 35% (Main Stats) OR 15% (Techs)";
            c.checked = true;
        } else {
            h.innerText = "Usually Flat Stats (+300)";
            c.checked = false;
        }
    }

    function saveCustomCharacter() {
        const name = document.getElementById('new_name').value;
        if(!name) return alert("Enter Name");
        const id = name.toLowerCase().replace(/\s+/g, '_');
        const newChar = {
            name: name,
            stats: {
                spike: parseFloat(document.getElementById('new_spike').value)||0,
                block: parseFloat(document.getElementById('new_block').value)||0,
                receive: parseFloat(document.getElementById('new_receive').value)||0,
                serve: parseFloat(document.getElementById('new_serve').value)||0,
                set: parseFloat(document.getElementById('new_set').value)||0,
                save: parseFloat(document.getElementById('new_save').value)||0,
                aware: parseFloat(document.getElementById('new_aware').value)||0,
                reflex: parseFloat(document.getElementById('new_reflex').value)||0,
                spirit: parseFloat(document.getElementById('new_spirit').value)||0,
                str: parseFloat(document.getElementById('new_str').value)||0,
                atech: parseFloat(document.getElementById('new_atech').value)||0,
                dtech: parseFloat(document.getElementById('new_dtech').value)||0
            }
        };
        characterDB[id] = newChar;
        let saved = JSON.parse(localStorage.getItem('hq_custom_chars')) || {};
        saved[id] = newChar;
        localStorage.setItem('hq_custom_chars', JSON.stringify(saved));
        updateCharDropdown();
        alert("Saved!");
    }

    function loadCustomChars() {
        let saved = JSON.parse(localStorage.getItem('hq_custom_chars')) || {};
        Object.assign(characterDB, saved);
    }
    
    function updateCharDropdown() {
        const sel = document.getElementById('charSelector');
        sel.innerHTML = '<option value="">-- Select --</option>';
        for(let key in characterDB) sel.innerHTML += `<option value="${key}">${characterDB[key].name}</option>`;
    }

    function updateMemoryDropdown() {
        const sel = document.getElementById('memorySelector');
        sel.innerHTML = '<option value="">-- None --</option>';
        for(let key in memoryDB) sel.innerHTML += `<option value="${key}">${memoryDB[key].name}</option>`;
    }

    function updateMemoryDesc() {
        const k = document.getElementById('memorySelector').value;
        document.getElementById('memoryDesc').innerText = (k && memoryDB[k]) ? "Effect: " + memoryDB[k].desc : "";
    }

    function selectSlot(n) {
        document.querySelectorAll('.team-slot').forEach(e => e.classList.remove('active'));
        document.getElementById(`slot${n}`).classList.add('active');
        activeSlot = n;
        const k = teamRoster[n-1];
        if(k && characterDB[k]) {
            document.getElementById('charSelector').value = k;
            loadStats(characterDB[k].stats);
        } else {
            document.getElementById('charSelector').value = "";
            loadStats({});
        }
    }

    function assignCharacter() {
        const k = document.getElementById('charSelector').value;
        if(!k) return;
        teamRoster[activeSlot-1] = k;
        document.getElementById(`name${activeSlot}`).innerText = characterDB[k].name;
        loadStats(characterDB[k].stats);
    }

    function loadStats(s) {
        const ids = ['spike','block','receive','serve','set','save','aware','reflex','spirit','str','atech','dtech'];
        ids.forEach(id => document.getElementById(`base_${id}`).value = s[id] || 0);
    }

    function addPotential() {
        const item = {
            id: idCounter++,
            set: document.getElementById('pot_set').value,
            slot: parseInt(document.getElementById('pot_slot').value),
            main: {
                type: document.getElementById('pot_main_type').value,
                val: parseFloat(document.getElementById('pot_main_val').value)||0,
                isPercent: document.getElementById('pot_main_is_percent').checked
            },
            subs: {
                spike: { flat: parseFloat(document.getElementById('sub_spike_flat').value)||0, pct: parseFloat(document.getElementById('sub_spike_pct').value)||0 },
                block: { flat: parseFloat(document.getElementById('sub_block_flat').value)||0, pct: parseFloat(document.getElementById('sub_block_pct').value)||0 },
                receive: { flat: parseFloat(document.getElementById('sub_receive_flat').value)||0, pct: parseFloat(document.getElementById('sub_receive_pct').value)||0 },
                serve: { flat: parseFloat(document.getElementById('sub_serve_flat').value)||0, pct: parseFloat(document.getElementById('sub_serve_pct').value)||0 },
                set: { flat: parseFloat(document.getElementById('sub_set_flat').value)||0, pct: parseFloat(document.getElementById('sub_set_pct').value)||0 },
                aware: { flat: parseFloat(document.getElementById('sub_aware_flat').value)||0, pct: parseFloat(document.getElementById('sub_aware_pct').value)||0 },
                reflex: { flat: parseFloat(document.getElementById('sub_reflex_flat').value)||0, pct: parseFloat(document.getElementById('sub_reflex_pct').value)||0 }
            }
        };
        inventory.push(item);
        saveInv();
        renderInv();
    }

    function saveInv() { localStorage.setItem('hq_inventory', JSON.stringify(inventory)); }
    function loadInventory() {
        const s = localStorage.getItem('hq_inventory');
        if(s) { inventory = JSON.parse(s); if(inventory.length) idCounter = Math.max(...inventory.map(i=>i.id))+1; renderInv(); }
    }
    function renderInv() {
        const l = document.getElementById('inventoryList');
        document.getElementById('count').innerText = inventory.length;
        l.innerHTML = "";
        inventory.forEach(i => {
            let stats = "";
            // Simplified display
            if(i.subs.spike.flat || i.subs.spike.pct) stats += `Spk:${i.subs.spike.flat}/${i.subs.spike.pct}% `;
            if(i.subs.receive.flat || i.subs.receive.pct) stats += `Rec:${i.subs.receive.flat}/${i.subs.receive.pct}% `;
            
            l.innerHTML += `<div class="item-box">
                <button class="btn-delete" onclick="delItem(${i.id})">x</button>
                <strong>${i.set}</strong> (S${i.slot}) | Main: ${i.main.val}${i.main.isPercent?'%':''} ${i.main.type}<br>
                <span style="font-size:0.8em; color:#666;">${stats}</span>
            </div>`;
        });
    }
    function delItem(id) { inventory = inventory.filter(i=>i.id!==id); saveInv(); renderInv(); }

    function getBuffs() {
        const b = {
            spike: parseFloat(document.getElementById('buff_spike').value)||0,
            block: parseFloat(document.getElementById('buff_block').value)||0,
            receive: parseFloat(document.getElementById('buff_receive').value)||0,
            serve: parseFloat(document.getElementById('buff_serve').value)||0,
            aware: parseFloat(document.getElementById('buff_aware').value)||0,
            reflex: parseFloat(document.getElementById('buff_reflex').value)||0,
            team: parseFloat(document.getElementById('buff_team').value)||1.0
        };
        const k = document.getElementById('memorySelector').value;
        if(k && memoryDB[k] && memoryDB[k].buffs) {
            for(let s in memoryDB[k].buffs) if(b[s] !== undefined) b[s] += memoryDB[k].buffs[s];
        }
        return b;
    }

    function runOptimizer() {
        const base = {};
        ['spike','block','receive','serve','set','save','aware','reflex','spirit','str','atech','dtech'].forEach(id => {
            base[id] = parseFloat(document.getElementById(`base_${id}`).value)||0;
        });
        const target = document.getElementById('targetStat').value;
        const buffs = getBuffs();

        const slots = {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
        inventory.forEach(i => slots[i.slot].push(i));
        const dummy = {set:"None", main:{val:0,isPercent:false}, subs:{
            spike:{flat:0,pct:0}, block:{flat:0,pct:0}, receive:{flat:0,pct:0}, 
            serve:{flat:0,pct:0}, set:{flat:0,pct:0}, aware:{flat:0,pct:0}, reflex:{flat:0,pct:0}
        }};
        for(let k=1; k<=6; k++) if(!slots[k].length) slots[k].push(dummy);

        let bestVal = -1, bestBuild = null;

        for(let s1 of slots[1]) for(let s2 of slots[2]) for(let s3 of slots[3]) 
        for(let s4 of slots[4]) for(let s5 of slots[5]) for(let s6 of slots[6]) {
            const build = [s1,s2,s3,s4,s5,s6];
            const stats = calcStats(base, build, target, buffs);
            if(stats.final > bestVal) { bestVal = stats.final; bestBuild = {build, stats}; }
        }

        const res = document.getElementById('resultDetails');
        document.getElementById('output').style.display = 'block';
        if(!bestBuild) { res.innerHTML = "No items."; return; }
        
        let html = `<div style="font-size:1.5em; color:#ff6b00;">Total ${target.toUpperCase()}: ${bestBuild.stats.final.toFixed(0)}</div>`;
        html += `<strong>Sets:</strong> ${bestBuild.stats.activeSets.join(', ')||"None"}<br><em>(Buffs: ${buffs[target]||0}%)</em><br><br>`;
        bestBuild.build.forEach(i => {
            if(i.set !== "None") html += `<div class="item-box">S${i.slot}: <strong>${i.set}</strong> (${i.main.val}${i.main.isPercent?'%':''} ${i.main.type})</div>`;
        });
        res.innerHTML = html;
    }

    function calcStats(base, items, target, buffs) {
        let flat = 0, pct = buffs[target]||0, sets = {};
        
        items.forEach(i => {
            if(i.set !== "None") sets[i.set] = (sets[i.set]||0)+1;
            
            // Main Stat
            if(i.main.type === target) {
                if(i.main.isPercent) pct += i.main.val; else flat += i.main.val;
            }
            // Substats (Handle both Flat and Pct)
            if(i.subs[target]) {
                flat += i.subs[target].flat;
                pct += i.subs[target].pct;
            }
        });

        let active = [];
        for(let s in sets) {
            if(sets[s] >= 2 && setBonuses[s] && setBonuses[s][2].stat === target) {
                pct += (setBonuses[s][2].val * 100);
                active.push(s);
            }
        }
        
        const final = (base[target] * buffs.team * (1 + (pct/100))) + flat;
        return { final, activeSets: active };
    }
</script>
</body>
</html>
