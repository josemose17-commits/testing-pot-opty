<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haikyu!! Ultimate Optimizer (Auto-SR Stats)</title>
    <style>
        :root { --hq-orange: #ff6b00; --hq-black: #1a1a1a; --hq-gray: #f4f4f9; --hq-blue: #0056b3; --hq-purple: #6f42c1; --hq-green: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--hq-gray); color: var(--hq-black); padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Layout */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2, h3 { color: var(--hq-orange); margin-top: 0; }
        
        /* Inputs */
        label { display: block; font-weight: bold; margin-top: 8px; font-size: 0.8em; color:#444; }
        input, select, textarea { width: 100%; padding: 6px; margin-top: 2px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .hint { font-size: 0.8em; color: #666; font-style: italic; margin-top: 2px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        
        .sub-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 5px; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 4px; }
        .sub-grid label { margin-top:0; font-size: 0.85em; }
        .sub-header { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 5px; font-weight: bold; font-size: 0.8em; color: var(--hq-orange); margin-bottom: 5px; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; background: var(--hq-orange); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .btn:hover { background: #e65c00; }
        .btn-green { background: var(--hq-green); } .btn-green:hover { background: #218838; }
        .btn-blue { background: #007bff; } .btn-blue:hover { background: #0056b3; }
        .btn-delete { background: #cc0000; padding: 2px 6px; font-size: 0.8em; color: white; border: none; cursor: pointer; float: right; }

        /* Team Styles */
        .team-row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px; }
        .team-slot { background: #eee; border: 2px solid #ccc; border-radius: 6px; padding: 8px 2px; text-align: center; cursor: pointer; transition: 0.2s; }
        .team-slot:hover { border-color: var(--hq-orange); }
        .team-slot.active { border-color: var(--hq-orange); background: #fff5eb; box-shadow: 0 0 8px rgba(255, 107, 0, 0.4); }
        .slot-role { font-size: 0.65em; color: #666; display: block; margin-bottom: 5px; text-transform: uppercase; }
        .slot-name { font-weight: bold; font-size: 0.75em; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Panels */
        .synergy-panel { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin-top: 15px; }
        .synergy-item { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #c3e6cb; }
        .synergy-title { font-weight: bold; display: block; }

        .item-box { border-left: 4px solid #ccc; background: #fff; padding: 10px; margin-bottom: 8px; font-size: 0.85em; position: relative; }
        .item-box.high-potential { border-left-color: var(--hq-green); background: #f0fff4; } 
        .item-box.low-potential { border-left-color: #dc3545; background: #fff5f5; } 
        
        .potential-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ccc; font-size: 0.9em; color: #333; }
        .pot-score { color: var(--hq-green); font-weight: bold; }
        .pot-chance { color: var(--hq-blue); font-weight: bold; }

        .result-box { background: #1a1a1a; color: white; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .creator-section { border-top: 2px dashed #ccc; margin-top: 20px; padding-top: 20px; }
        .ref-panel { background: #fff8e1; padding: 10px; border: 1px solid #ffc107; font-size: 0.8em; margin-bottom: 15px; border-radius: 6px;}
        .io-panel { background: #e2e6ea; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #adb5bd; }
    </style>
</head>
<body>

<h1>üèê Haikyu!! Ultimate Optimizer</h1>

<div class="card">
    <h2>1. Team Roster & Synergy</h2>
    <div class="team-row">
        <div class="team-slot active" onclick="selectSlot(1)" id="slot1"><span class="slot-role">Slot 1</span><span class="slot-name" id="name1">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(2)" id="slot2"><span class="slot-role">Slot 2</span><span class="slot-name" id="name2">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(3)" id="slot3"><span class="slot-role">Slot 3</span><span class="slot-name" id="name3">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(4)" id="slot4"><span class="slot-role">Slot 4</span><span class="slot-name" id="name4">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(5)" id="slot5"><span class="slot-role">Slot 5</span><span class="slot-name" id="name5">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(6)" id="slot6"><span class="slot-role">Slot 6</span><span class="slot-name" id="name6">Empty</span></div>
        <div class="team-slot" onclick="selectSlot(7)" id="slot7" style="border-color: #0056b3; background: #eef6ff;"><span class="slot-role" style="color:#0056b3;">LIBERO</span><span class="slot-name" id="name7">Empty</span></div>
    </div>
    
    <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
        <div>
            <label>Active Character:</label>
            <select id="charSelector" onchange="assignCharacter()"><option value="">-- Select --</option></select>
        </div>
        <div>
            <label>Target SR Level:</label>
            <select id="srSelector" onchange="updateSynergyDisplay()">
                <option value="0">SR 0 (Base)</option>
                <option value="1">SR 1 (+13% Base)</option>
                <option value="2">SR 2 (Skill)</option>
                <option value="3">SR 3 (+26% Base)</option>
                <option value="4">SR 4 (Passive)</option>
                <option value="5">SR 5 (+39% Base)</option>
            </select>
        </div>
    </div>
    
    <div id="synergyPanel" class="synergy-panel" style="display:none;">
        <h3>‚úÖ Active Synergy & Skills</h3>
        <div id="synergyContent"></div>
    </div>

    <div class="creator-section">
        <h3>‚ûï Add Custom Character</h3>
        <div class="stat-grid">
            <div style="grid-column: span 3;"><input type="text" id="new_name" placeholder="Name"></div>
            <div><input type="number" id="new_spike" placeholder="Spike (Base)"></div>
            <div><input type="number" id="new_block" placeholder="Block"></div>
            <div><input type="number" id="new_receive" placeholder="Rec"></div>
            <div><input type="number" id="new_serve" placeholder="Serve"></div>
            <div><input type="number" id="new_set" placeholder="Set"></div>
            <div><input type="number" id="new_save" placeholder="Save"></div>
            <div><input type="number" id="new_aware" placeholder="Aware"></div>
            <div><input type="number" id="new_reflex" placeholder="Reflex"></div>
            <div><input type="number" id="new_spirit" placeholder="Spirit"></div>
            <div><input type="number" id="new_str" placeholder="Strength"></div>
            <div><input type="number" id="new_atech" placeholder="Atk Tech"></div>
            <div><input type="number" id="new_dtech" placeholder="Def Tech"></div>
        </div>
        <button class="btn btn-green" onclick="saveCustomCharacter()">Save Character</button>
    </div>
</div>

<div class="grid-container">
    <div>
        <div class="card">
            <h2>2. Stats & Conditions</h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <p class="hint" style="margin:0;">Base Stats (Input values):</p>
                <div style="font-size:0.8em;">
                    <label style="display:inline;">Input Stats are at SR:</label>
                    <select id="inputSR" style="width:auto; padding:2px;" onchange="updateSynergyDisplay()">
                        <option value="0">SR 0 (Raw)</option>
                        <option value="1" selected>SR 1 (Default)</option>
                        <option value="3">SR 3</option>
                        <option value="5">SR 5</option>
                    </select>
                </div>
            </div>
            
            <div class="stat-grid" style="margin-bottom: 15px;">
                <div><label>Spike</label><input type="number" id="base_spike" value="0"></div>
                <div><label>Block</label><input type="number" id="base_block" value="0"></div>
                <div><label>Receive</label><input type="number" id="base_receive" value="0"></div>
                <div><label>Serve</label><input type="number" id="base_serve" value="0"></div>
                <div><label>Set</label><input type="number" id="base_set" value="0"></div>
                <div><label>Save</label><input type="number" id="base_save" value="0"></div>
                <div><label>Aware</label><input type="number" id="base_aware" value="0"></div>
                <div><label>Reflex</label><input type="number" id="base_reflex" value="0"></div>
                <div><label>Spirit</label><input type="number" id="base_spirit" value="0"></div>
                <div><label>Strength</label><input type="number" id="base_str" value="0"></div>
                <div><label>Atk Tech</label><input type="number" id="base_atech" value="0"></div>
                <div><label>Def Tech</label><input type="number" id="base_dtech" value="0"></div>
            </div>

            <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border: 1px solid var(--hq-purple); margin-bottom:15px;">
                <h3 style="color:var(--hq-purple); margin:0;">üß† Equip Memory</h3>
                <select id="memorySelector" onchange="updateMemoryDesc()"><option value="">-- None --</option></select>
                <div id="memoryDesc" style="font-size:0.85em; margin-top:5px; font-style:italic;"></div>
            </div>

            <div style="background: #eef6ff; padding: 15px; border-radius: 8px; border: 1px solid #0056b3;">
                <h3>‚öîÔ∏è Battle Conditions</h3>
                <p class="hint"><strong>Manually add</strong> calculated buffs from Synergy box above.</p>
                <div class="stat-grid">
                    <div><label>Atk %</label><input type="number" id="buff_spike" placeholder="0"></div>
                    <div><label>Block %</label><input type="number" id="buff_block" placeholder="0"></div>
                    <div><label>Rec %</label><input type="number" id="buff_receive" placeholder="0"></div>
                    <div><label>Serve %</label><input type="number" id="buff_serve" placeholder="0"></div>
                    <div><label>Aware %</label><input type="number" id="buff_aware" placeholder="0"></div>
                    <div><label>Reflex %</label><input type="number" id="buff_reflex" placeholder="0"></div>
                    <div><label>Team X</label><input type="number" id="buff_team" placeholder="1.0" value="1.0"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>4. Optimizer</h2>
            <label>Target Stat:</label>
            <select id="targetStat" onchange="refreshInventoryDisplay()">
                <option value="quick">Quick Attack (MB)</option>
                <option value="power">Power Attack (WS/OP)</option>
                <option value="block">Block</option>
                <option value="receive">Receive</option>
                <option value="serve">Serve</option>
                <option value="set">Set</option>
                <option value="save">Save</option>
            </select>
            <button class="btn" onclick="runOptimizer()">Find Best Build</button>
            <div id="output" class="result-box" style="display:none;">
                <h3>üèÜ Best Build</h3>
                <div id="resultDetails"></div>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <h2>3. Potential Inventory</h2>
            
            <div class="ref-panel">
                <strong>Growth Rates:</strong><br>
                Flat +24 | % +2% (Power/Quick/Blk/Rec/Srv/Set/Save)<br>
                Spirit/Str +3.2% | Reflex/Awar +1.6% | Techs +1.2%
            </div>

            <div style="border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px;">
                <label>Set Name</label>
                <select id="pot_set">
                    <option value="Power Vibe">Power Vibe</option>
                    <option value="Assist Receive">Assist Receive</option>
                    <option value="Supreme Receive">Supreme Receive</option>
                    <option value="Precise Set">Precise Set</option>
                    <option value="Rapid Attack">Rapid Attack</option>
                    <option value="Sharp Sense">Sharp Sense</option>
                    <option value="Precise Block">Precise Block</option>
                    <option value="Block Movement">Block Movement</option>
                    <option value="Other">Other</option>
                </select>

                <div class="stat-grid" style="grid-template-columns: 1fr 1fr;">
                    <div><label>Slot</label><select id="pot_slot" onchange="updateSlotHint()"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                    <div><label>Main Type</label><select id="pot_main_type">
                        <option value="quick">Quick Atk</option>
                        <option value="power">Power Atk</option>
                        <option value="block">Block</option>
                        <option value="receive">Receive</option>
                        <option value="serve">Serve</option>
                        <option value="set">Set</option>
                        <option value="save">Save</option>
                        <option value="aware">Aware</option>
                        <option value="reflex">Reflex</option>
                        <option value="spirit">Spirit</option>
                        <option value="str">Strength</option>
                        <option value="atech">Atk Tech</option>
                        <option value="dtech">Def Tech</option>
                    </select></div>
                </div>

                <div class="stat-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div style="grid-column: span 2"><label>Main Val</label><input type="number" id="pot_main_val" placeholder="300"></div>
                    <div style="margin-top:35px;"><label><input type="checkbox" id="pot_main_is_percent"> Is %?</label></div>
                </div>
                
                <div style="background: #fff3cd; padding:5px; margin-top:5px; border-radius:4px;">
                    <label>Current Level</label>
                    <select id="pot_level">
                        <option value="0">Lv 0 (4 Upgrades Left)</option>
                        <option value="3">Lv 3 (3 Upgrades Left)</option>
                        <option value="6">Lv 6 (2 Upgrades Left)</option>
                        <option value="9">Lv 9 (1 Upgrade Left)</option>
                        <option value="12">Lv 12 (Maxed)</option>
                    </select>
                </div>
                <div id="slotHint" class="hint" style="color:#d32f2f; margin-bottom:10px;"></div>

                <div class="sub-header"><div>Stat</div><div>Flat</div><div>%</div></div>
                <div class="sub-grid">
                    <label>Quick Atk</label> <input type="number" id="sub_quick_flat" placeholder="24"> <input type="number" id="sub_quick_pct" placeholder="2">
                    <label>Power Atk</label> <input type="number" id="sub_power_flat" placeholder="0"> <input type="number" id="sub_power_pct" placeholder="0">
                    <label>Block</label> <input type="number" id="sub_block_flat" placeholder="0"> <input type="number" id="sub_block_pct" placeholder="0">
                    <label>Receive</label> <input type="number" id="sub_receive_flat" placeholder="0"> <input type="number" id="sub_receive_pct" placeholder="0">
                    <label>Serve</label> <input type="number" id="sub_serve_flat" placeholder="0"> <input type="number" id="sub_serve_pct" placeholder="0">
                    <label>Set</label> <input type="number" id="sub_set_flat" placeholder="0"> <input type="number" id="sub_set_pct" placeholder="0">
                    <label>Save</label> <input type="number" id="sub_save_flat" placeholder="0"> <input type="number" id="sub_save_pct" placeholder="0">
                    <label>Strength</label> <input disabled style="background:#eee"> <input type="number" id="sub_str_pct" placeholder="3.2">
                    <label>Spirit</label> <input disabled style="background:#eee"> <input type="number" id="sub_spirit_pct" placeholder="3.2">
                    <label>Aware</label> <input disabled style="background:#eee"> <input type="number" id="sub_aware_pct" placeholder="1.6">
                    <label>Reflex</label> <input disabled style="background:#eee"> <input type="number" id="sub_reflex_pct" placeholder="1.6">
                </div>
                
                <button class="btn btn-secondary" onclick="addPotential()">+ Add Potential</button>
            </div>

            <h3>Inventory (<span id="count">0</span>)</h3>
            <div id="inventoryList" style="max-height: 400px; overflow-y: auto;"></div>
            
            <div class="io-panel">
                <strong>üíæ Backup / Restore</strong>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:5px;">
                    <button class="btn btn-blue" style="margin:0" onclick="exportData()">Export</button>
                    <button class="btn btn-green" style="margin:0" onclick="importData()">Import</button>
                </div>
                <textarea id="io_area" rows="2" placeholder="Paste data here..." style="margin-top:5px;"></textarea>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONSTANTS ---
    const GROWTH = {
        flat: 24, // Quick, Power, Block, Rec, Srv, Set, Save
        pct: 2.0,
        high_pct: 3.2, // Spirit, Strength
        mid_pct: 1.6,  // Reflex, Aware
        low_pct: 1.2   // Techs
    };

    // --- DATA ---
    let characterDB = {
        "tsukishima_sp": { 
            name: "Tsukishima SP (MB)", 
            stats: { spike: 1948, receive: 1661, serve: 1668, block: 1769, set: 1579, save: 1753, aware: 0, reflex:0, spirit:0, str: 0, atech:0, dtech:0 },
            bonds: [
                { partner: "hinata_sp", name: "Sun vs Moon", desc: "Awareness +X% when Hinata Quick Crits." },
                { partner: "kuroo_sp", name: "Hanabi Festival", desc: "Basic Stats Increased. Rage debuff on enemy." }
            ],
            sr: {
                2: "Atk Mode: +15% Atk Tech, +20% Def Tech. Def Mode: +15% Def Tech, +20% Atk Tech.",
                4: "Spirit & Strength +40%. Criticals boost power."
            }
        },
        "hinata_sp": { name: "Hinata SP (MB)", stats: { spike: 1800 }, bonds: [] },
        "kuroo_sp": { name: "Kuroo SP (MB)", stats: { block: 1800 }, bonds: [] }
    };
    
    let memoryDB = {
        "mem_tsuki_sp": { name: "Tsukishima SP Memory", desc: "Quick Atk +24%. Good Play = Block +9% (Stack x3).", buffs: { quick: 24 } },
        "mem_generic": { name: "Generic Memory", desc: "No base buffs.", buffs: {} }
    };
    
    const setBonuses = {
        "Power Vibe": { 2: {stat: "power", val: 0.15} }, "Assist Receive": { 2: {stat: "receive", val: 0.15} }, 
        "Supreme Receive": { 2: {stat: "receive", val: 0.15} }, "Precise Set": { 2: {stat: "set", val: 0.15} },
        "Rapid Attack": { 2: {stat: "quick", val: 0.15} }, "Sharp Sense": { 2: {stat: "quick", val: 0.15} },
        "Precise Block": { 2: {stat: "block", val: 0.15} }, "Block Movement": { 2: {stat: "block", val: 0.15} }
    };

    // --- STATE ---
    let activeSlot = 1;
    let teamRoster = Array(7).fill(null); 
    let teamSR = Array(7).fill(1); // Default SR1
    let inventory = [];
    let idCounter = 0;

    window.onload = function() {
        loadCustomChars(); updateCharDropdown(); updateMemoryDropdown(); loadInventory(); updateSlotHint();
        // Set default SR to 1
        document.getElementById('srSelector').value = "1";
    };

    // --- ANALYZER (No changes, same as before) ---
    function analyzePotential(item, targetStat) {
        const level = item.level || 0;
        const rollsLeft = 4 - Math.floor(level / 3);
        if (rollsLeft <= 0) return { chance: 0, avgGain: 0, label: "Maxed" };

        let hitCount = 0;
        const map = {
            'quick': ['quick','str','aware','atech'],
            'power': ['power','str','aware','atech'],
            'block': ['block','spirit','reflex','dtech'],
            'receive': ['receive','spirit','reflex','dtech'],
            'serve': ['serve','str','aware','atech'],
            'set': ['set','aware','atech'],
            'save': ['save','reflex','dtech']
        };
        const targets = map[targetStat] || [targetStat];

        let avgGainPerRoll = 0;
        for (let key in item.subs) {
            let isHit = false;
            let val = 0;
            if (item.subs[key].flat > 0 && targets.includes(key)) { isHit=true; val=GROWTH.flat; }
            if (item.subs[key].pct > 0 && targets.includes(key)) {
                isHit = true; 
                if(['str','spirit'].includes(key)) val = GROWTH.high_pct * 15;
                else if(['aware','reflex'].includes(key)) val = GROWTH.mid_pct * 15;
                else val = GROWTH.pct * 15;
            }
            if(isHit) { hitCount++; avgGainPerRoll += (val / 4); }
        }

        let chance = (hitCount / 4) * 100;
        let totalGain = avgGainPerRoll * rollsLeft;
        return { chance, avgGain: totalGain, label: `${chance.toFixed(0)}% Chance`, css: chance >= 50 ? "high-potential" : "low-potential" };
    }

    // --- UI & SYNERGY ---
    function updateSlotHint() {
        const s = document.getElementById('pot_slot').value;
        const h = document.getElementById('slotHint');
        const c = document.getElementById('pot_main_is_percent');
        if(s === "2") { h.innerText = "Max: 35% (Set/Power/Quick/Srv) OR 20% (Aware/Str)"; c.checked = true; } 
        else if(s === "4") { h.innerText = "Max: 35% (Blk/Rec) OR 20% (Reflex/Spirit)"; c.checked = true; } 
        else if(s === "6") { h.innerText = "Max: 35% (Main) OR 15% (Techs)"; c.checked = true; } 
        else { h.innerText = "Usually Flat Stats (+300)"; c.checked = false; }
    }

    function addPotential() {
        // ... (Same Add Potential logic as previous version, abbreviated) ...
        const item = {
            id: idCounter++, set: document.getElementById('pot_set').value, slot: parseInt(document.getElementById('pot_slot').value),
            level: parseInt(document.getElementById('pot_level').value)||0,
            main: { type: document.getElementById('pot_main_type').value, val: parseFloat(document.getElementById('pot_main_val').value)||0, isPercent: document.getElementById('pot_main_is_percent').checked },
            subs: {
                quick: { flat: parseFloat(document.getElementById('sub_quick_flat').value)||0, pct: parseFloat(document.getElementById('sub_quick_pct').value)||0 },
                power: { flat: parseFloat(document.getElementById('sub_power_flat').value)||0, pct: parseFloat(document.getElementById('sub_power_pct').value)||0 },
                block: { flat: parseFloat(document.getElementById('sub_block_flat').value)||0, pct: parseFloat(document.getElementById('sub_block_pct').value)||0 },
                receive: { flat: parseFloat(document.getElementById('sub_receive_flat').value)||0, pct: parseFloat(document.getElementById('sub_receive_pct').value)||0 },
                serve: { flat: parseFloat(document.getElementById('sub_serve_flat').value)||0, pct: parseFloat(document.getElementById('sub_serve_pct').value)||0 },
                set: { flat: parseFloat(document.getElementById('sub_set_flat').value)||0, pct: parseFloat(document.getElementById('sub_set_pct').value)||0 },
                save: { flat: parseFloat(document.getElementById('sub_save_flat').value)||0, pct: parseFloat(document.getElementById('sub_save_pct').value)||0 },
                str: { flat: 0, pct: parseFloat(document.getElementById('sub_str_pct').value)||0 },
                spirit: { flat: 0, pct: parseFloat(document.getElementById('sub_spirit_pct').value)||0 },
                aware: { flat: 0, pct: parseFloat(document.getElementById('sub_aware_pct').value)||0 },
                reflex: { flat: 0, pct: parseFloat(document.getElementById('sub_reflex_pct').value)||0 }
            }
        };
        inventory.push(item); saveInv(); renderInv();
    }

    function renderInv() {
        const l = document.getElementById('inventoryList');
        const target = document.getElementById('targetStat').value;
        document.getElementById('count').innerText = inventory.length;
        l.innerHTML = "";
        inventory.forEach(i => {
            let stats = [];
            for(let k in i.subs) {
                if(i.subs[k].flat > 0) stats.push(`${k.substr(0,3)}:${i.subs[k].flat}`);
                if(i.subs[k].pct > 0) stats.push(`${k.substr(0,3)}%:${i.subs[k].pct}`);
            }
            const analysis = analyzePotential(i, target);
            l.innerHTML += `<div class="item-box ${analysis.css}">
                <button class="btn-delete" onclick="delItem(${i.id})">x</button>
                <strong>${i.set}</strong> (S${i.slot}) Lv${i.level}<br>
                Main: ${i.main.val}${i.main.isPercent?'%':''} ${i.main.type}<br>
                <span style="font-size:0.8em; color:#666;">${stats.join(', ')}</span>
                <div class="potential-stats"><span class="pot-chance">üé≤ ${analysis.label}</span><span class="pot-score">üìà Avg: +${analysis.avgGain.toFixed(0)}</span></div>
            </div>`;
        });
    }

    // --- SYNERGY FUNCTIONS ---
    function updateSynergyDisplay() {
        const k = document.getElementById('charSelector').value;
        const sr = parseInt(document.getElementById('srSelector').value);
        teamSR[activeSlot-1] = sr; // Save SR level

        const panel = document.getElementById('synergyPanel');
        const content = document.getElementById('synergyContent');
        content.innerHTML = "";
        
        if(!k || !characterDB[k]) { panel.style.display="none"; return; }
        
        panel.style.display = "block";
        const char = characterDB[k];

        // 0. Base Stat Calculation Logic display
        const inputSR = parseInt(document.getElementById('inputSR').value);
        const mult = getSRMult(sr, inputSR);
        if(mult > 1.0) {
            const pct = Math.round((mult - 1.0)*100);
            content.innerHTML += `<div class="synergy-item"><span class="synergy-title">üìà Base Stats (Auto-Calc)</span>+${pct}% Bonus applied to optimization (Input SR${inputSR} -> Target SR${sr})</div>`;
        }

        // 1. Resonance
        if(char.sr) {
            for(let level in char.sr) {
                if(sr >= parseInt(level)) {
                    content.innerHTML += `<div class="synergy-item"><span class="synergy-title">‚≠ê SR ${level} Active</span>${char.sr[level]}</div>`;
                }
            }
        }
        
        // 2. Bonds
        if(char.bonds) {
            char.bonds.forEach(bond => {
                if(teamRoster.includes(bond.partner)) {
                    content.innerHTML += `<div class="synergy-item"><span class="synergy-title">üîó Bond: ${bond.name}</span>${bond.desc}</div>`;
                }
            });
        }
    }

    function getSRMult(targetSR, inputSR) {
        // Calculate cumulative multipliers
        // SR1: +13% (1.13)
        // SR3: +13% (1.26)
        // SR5: +13% (1.39)
        const getVal = (lvl) => {
            let val = 1.0;
            if(lvl >= 1) val += 0.13;
            if(lvl >= 3) val += 0.13;
            if(lvl >= 5) val += 0.13;
            return val;
        };

        const currentVal = getVal(inputSR);
        const targetVal = getVal(targetSR);
        
        // Return ratio to adjust base stats
        // e.g. Input SR1 (1.13), Target SR3 (1.26). Mult = 1.26 / 1.13 = 1.115 (+11.5%)
        return targetVal / currentVal;
    }

    // --- HELPERS (Same as before) ---
    function saveInv() { localStorage.setItem('hq_inventory', JSON.stringify(inventory)); }
    function loadInventory() { const s = localStorage.getItem('hq_inventory'); if(s) { inventory = JSON.parse(s); idCounter = Math.max(...inventory.map(i=>i.id))+1; renderInv(); } }
    function delItem(id) { inventory = inventory.filter(i=>i.id!==id); saveInv(); renderInv(); }
    function exportData() { navigator.clipboard.writeText(JSON.stringify(inventory)); alert("Copied!"); }
    function importData() { try { inventory = JSON.parse(document.getElementById('io_area').value); saveInv(); renderInv(); alert("Loaded!"); } catch(e) { alert("Error"); } }
    
    function saveCustomCharacter() {
        const id = document.getElementById('new_name').value.toLowerCase().replace(/\s+/g,'_');
        const c = { name: document.getElementById('new_name').value, stats: {}, bonds:[], sr:{} };
        ['spike','block','receive','serve','set','save','aware','reflex','spirit','str','atech','dtech'].forEach(k => c.stats[k] = parseFloat(document.getElementById(`new_${k}`).value)||0);
        characterDB[id] = c;
        localStorage.setItem('hq_custom_chars', JSON.stringify(characterDB));
        updateCharDropdown();
    }
    function loadCustomChars() { Object.assign(characterDB, JSON.parse(localStorage.getItem('hq_custom_chars'))||{}); }
    function updateCharDropdown() { const s=document.getElementById('charSelector'); s.innerHTML='<option value="">-- Select --</option>'; for(let k in characterDB) s.innerHTML += `<option value="${k}">${characterDB[k].name}</option>`; }
    function updateMemoryDropdown() { const s=document.getElementById('memorySelector'); s.innerHTML='<option value="">-- None --</option>'; for(let k in memoryDB) s.innerHTML += `<option value="${k}">${memoryDB[k].name}</option>`; }
    function updateMemoryDesc() { const k=document.getElementById('memorySelector').value; document.getElementById('memoryDesc').innerText = (k && memoryDB[k]) ? memoryDB[k].desc : ""; }
    
    function selectSlot(n) {
        document.querySelectorAll('.team-slot').forEach(e => e.classList.remove('active'));
        document.getElementById(`slot${n}`).classList.add('active');
        activeSlot = n;
        const k = teamRoster[n-1];
        if(k) { 
            document.getElementById('charSelector').value = k; 
            document.getElementById('srSelector').value = teamSR[n-1]; // Restore SR
            loadStats(characterDB[k].stats); 
        } else { 
            document.getElementById('charSelector').value=""; 
            document.getElementById('srSelector').value=1; // Default SR1
            loadStats({}); 
        }
        updateSynergyDisplay(); // Refresh
    }
    
    function assignCharacter() { 
        const k=document.getElementById('charSelector').value; 
        if(k) { 
            teamRoster[activeSlot-1]=k; 
            document.getElementById(`name${activeSlot}`).innerText=characterDB[k].name; 
            loadStats(characterDB[k].stats); 
            updateSynergyDisplay();
        } 
    }
    function loadStats(s) { ['spike','block','receive','serve','set','save','aware','reflex','spirit','str','atech','dtech'].forEach(k => document.getElementById(`base_${k}`).value = s[k]||0); renderInv(); }

    function getBuffs() {
        const b = { quick:0, power:0, block:0, receive:0, serve:0, set:0, save:0, aware:0, reflex:0, team:1.0 };
        b.spike = parseFloat(document.getElementById('buff_spike').value)||0; 
        b.quick += b.spike; b.power += b.spike;
        b.block = parseFloat(document.getElementById('buff_block').value)||0;
        b.receive = parseFloat(document.getElementById('buff_receive').value)||0;
        b.serve = parseFloat(document.getElementById('buff_serve').value)||0;
        b.aware = parseFloat(document.getElementById('buff_aware').value)||0;
        b.reflex = parseFloat(document.getElementById('buff_reflex').value)||0;
        b.team = parseFloat(document.getElementById('buff_team').value)||1.0;
        const k = document.getElementById('memorySelector').value;
        if(k && memoryDB[k].buffs) for(let s in memoryDB[k].buffs) b[s] += memoryDB[k].buffs[s];
        return b;
    }

    function runOptimizer() {
        // 1. Get Base Stats
        const base = {};
        ['spike','block','receive','serve','set','save','aware','reflex','spirit','str','atech','dtech'].forEach(k => base[k] = parseFloat(document.getElementById(`base_${k}`).value)||0);
        
        // 2. Apply Auto-SR Math
        const targetSR = parseInt(document.getElementById('srSelector').value);
        const inputSR = parseInt(document.getElementById('inputSR').value);
        const srMult = getSRMult(targetSR, inputSR);
        
        // Apply multiplier to all base stats
        for(let k in base) base[k] = base[k] * srMult;

        base.quick = base.spike; base.power = base.spike; 
        
        const target = document.getElementById('targetStat').value;
        const buffs = getBuffs();
        
        const slots = {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
        inventory.forEach(i => slots[i.slot].push(i));
        const dummy = {set:"None", main:{val:0,isPercent:false}, subs:{quick:{flat:0,pct:0},power:{flat:0,pct:0}}};
        for(let k=1; k<=6; k++) if(!slots[k].length) slots[k].push(dummy);

        let bestVal = -1, bestBuild = null;
        for(let s1 of slots[1]) for(let s2 of slots[2]) for(let s3 of slots[3]) 
        for(let s4 of slots[4]) for(let s5 of slots[5]) for(let s6 of slots[6]) {
            const build = [s1,s2,s3,s4,s5,s6];
            const stats = calcStats(base, build, target, buffs);
            if(stats.final > bestVal) { bestVal = stats.final; bestBuild = {build, stats}; }
        }

        const res = document.getElementById('resultDetails');
        document.getElementById('output').style.display = 'block';
        if(!bestBuild) { res.innerHTML = "No items."; return; }
        
        let html = `<div style="font-size:1.5em; color:#ff6b00;">Total ${target.toUpperCase()}: ${bestBuild.stats.final.toFixed(0)}</div>`;
        if(srMult > 1.0) html += `<div style="color:#28a745; font-size:0.9em;">(Includes +${Math.round((srMult-1)*100)}% Base Stat Bonus from SR${targetSR})</div>`;
        html += `<strong>Sets:</strong> ${bestBuild.stats.activeSets.join(', ')||"None"}<br><em>(Buffs: ${buffs[target]||0}%)</em><br><br>`;
        bestBuild.build.forEach(i => {
            if(i.set !== "None") html += `<div class="item-box">S${i.slot}: <strong>${i.set}</strong> (${i.main.val}${i.main.isPercent?'%':''} ${i.main.type})</div>`;
        });
        res.innerHTML = html;
    }

    function calcStats(base, items, target, buffs) {
        let flat = 0, pct = buffs[target]||0, sets = {};
        items.forEach(i => {
            if(i.set !== "None") sets[i.set] = (sets[i.set]||0)+1;
            if(i.main.type === target) { if(i.main.isPercent) pct += i.main.val; else flat += i.main.val; }
            if(i.subs[target]) { flat += i.subs[target].flat; pct += i.subs[target].pct; }
        });
        let active = [];
        for(let s in sets) {
            if(sets[s] >= 2 && setBonuses[s] && setBonuses[s][2].stat === target) { pct += (setBonuses[s][2].val * 100); active.push(s); }
        }
        const final = (base[target] * buffs.team * (1 + (pct/100))) + flat;
        return { final, activeSets: active };
    }
</script>
</body>
</html>
